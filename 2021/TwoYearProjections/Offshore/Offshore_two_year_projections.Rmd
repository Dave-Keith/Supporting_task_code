---
title: "2 year projections"
# output: pdf
#   # flexdashboard::flex_dashboard:
#     # theme: bootstrap
# orientation: columns
# vertical_layout: fill

# storyboard: true
#runtime: shiny
#runtime: shiny_prerendered #  This is supposed to render all the plots right off the bat, so slower first time, but makes moving between pages really quick...
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(dplyr.summarise.inform = FALSE)
options(dplyr.join.inform = FALSE)
require(purrr)

```

```{r}
## run the projections

source("./Offshore/two_year_projections_offshore.R")
SP <- read.csv("Y:/Projects/CSAS/2y_Projection_RAP/data/SP_by_areas_by_DK.csv")
HCRs <- data.frame(area = c("BBn", "GBa"), exploitation = c(0.15, 0.25))

area <- "BBn"

SPscenario <- list(0, SP$mn[SP$Subarea==area], NULL)
out <- map(SPscenario, function(x) two_year_projections_offshore(area=area,
                                                               year=2019, 
                                                               exploitation=HCRs$exploitation[HCRs$area==area], 
                                                               runtype=c("Decision tables and plots"), #"Decision tables only"),
                                                               plot=c("Standard boxplot"), #"Functional boxplot"),
                                                               surplus = x, # if NULL, then it runs the full model, using m, mR, g, gR, etc. For final years, it just repeats them. 
                                                               sample=0.001,
                                                               path="Repo working directory (fast)", 
                                                               save=T))

```


# Results
```{r}

require(patchwork)
# plot_grid(plot_drt_cod$drt + xlab(NULL), plot_drt_had$drt + ylab(NULL) + xlab(NULL), plot_drt_ytf$drt +ylab(NULL) + xlab(NULL), plot_dt_cod$dt, plot_dt_had$dt + ylab(NULL), plot_dt_ytf$dt + ylab(NULL), ncol=3, align="v")

# pred.eval
png(paste0("./Offshore/", area, "/pred.eval.png"))

out[[1]]$realized$pred.eval + out[[2]]$realized$pred.eval + out[[3]]$realized$pred.eval 


out[[1]]$realized$zoom.pred.eval + out[[2]]$realized$zoom.pred.eval + out[[3]]$realized$zoom.pred.eval


out[[1]]$realized$evaluation1 + out[[2]]$realized$evaluation1 + out[[3]]$realized$evaluation1 


out[[1]]$realized$evaluation2 + out[[2]]$realized$evaluation2 + out[[3]]$realized$evaluation2


out[[1]]$impact_HCR1$evaluation3 + out[[2]]$impact_HCR1$evaluation3 + out[[3]]$impact_HCR1$evaluation3


out[[1]]$impact_HCR2$evaluation3 + out[[2]]$impact_HCR2$evaluation3 + out[[3]]$impact_HCR2$evaluation3



for(i in 1:length(out)) {
  
  if(i==1) print("Zero surplus production scenario")
  if(i==2) print("Median surplus production scenario")
  if(i==3) print("Last year's surplus production scenario")
  
  
  
  print("Realized projection evaluation")
  
  print(out[[i]]$realized$pred.eval)
  
  print(out[[i]]$realized$zoom.pred.eval)
  
  print(out[[i]]$realized$evaluation1)
  
  print(out[[i]]$realized$evaluation2)
  
  
  
  print("Exploitation-based projection evaluation")
  
  print(out[[1]]$exploit.based$pred.eval)
  
  print(out[[1]]$exploit.based$zoom.pred.eval)
  
  print(out[[1]]$exploit.based$evaluation1)
  
  print(out[[1]]$exploit.based$evaluation2)
  
  
  print("Realized decision from y1 (2020)")
  
  print(out[[1]]$decision.1)
  
  
  print("Range of exploitations for decision for y2 (2021) (based on y1 realized removals)")
  
  print(out[[1]]$decision.2[out[[1]]$decision.2$year==2020,])
  
  
  
  
  print("Decision impact")
  
  print(out[[1]]$evaluation3)
}


```


